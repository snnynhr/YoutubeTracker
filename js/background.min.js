var SIZE=101,CUTOFF=20,curr=JSON.parse(localStorage.getItem("bst")),num=localStorage.getItem("num"),dss=localStorage.getItem("dss"),min=localStorage.getItem("min"),q=localStorage.getItem("queue");
function initSystem(){null===curr&&initBst();null===num&&initNum();null===q&&initQueue();null!==dss?dss=parseInt(dss):localStorage.setItem("dss",SIZE);null!==min?min=parseInt(min):localStorage.setItem("min",CUTOFF);initQueue();window.webkitRequestFileSystem(window.TEMPORARY,1048576,onAppendInitFs,errorHandlerInit)}
function errorHandlerInit(b){msg="";switch(b.code){case FileError.QUOTA_EXCEEDED_ERR:msg="QUOTA_EXCEEDED_ERR";break;case FileError.NOT_FOUND_ERR:window.webkitRequestFileSystem(window.TEMPORARY,1048576,onWriteInitFs,errorHandler);break;case FileError.SECURITY_ERR:msg="SECURITY_ERR";break;case FileError.INVALID_MODIFICATION_ERR:msg="INVALID_MODIFICATION_ERR";break;case FileError.INVALID_STATE_ERR:msg="INVALID_STATE_ERR";break;default:msg="Unknown Error"}""!==msg&&console.log("Error: "+msg)}initSystem();
function initBst(){for(var b=parseInt(localStorage.getItem("dss")),a=[],c=0,c=0;c<b;c++)a[c]=[];localStorage.setItem("bst",JSON.stringify(a))}function initNum(){localStorage.setItem("num",0)}function initQueue(){localStorage.setItem("queue",JSON.stringify([void 0,void 0,void 0,void 0,void 0]))}function djb2(b){for(var a=5381,c=0,c=0;c<b.length;c++)a=(a<<5)+a+b.charCodeAt(c);return a}
function sha(b){var a=parseInt(localStorage.getItem("dss"));x=new BigInteger(SHA1(b),16);y=new BigInteger(a.toString(16),16);z=x.mod(y);return parseInt(z.toString(16),16)}
function errorHandler(b){var a="";switch(b.code){case FileError.QUOTA_EXCEEDED_ERR:a="QUOTA_EXCEEDED_ERR";break;case FileError.NOT_FOUND_ERR:a="NOT_FOUND_ERR";break;case FileError.SECURITY_ERR:a="SECURITY_ERR";break;case FileError.INVALID_MODIFICATION_ERR:a="INVALID_MODIFICATION_ERR";break;case FileError.INVALID_STATE_ERR:a="INVALID_STATE_ERR";break;default:a="Unknown Error"}console.log("Error: "+a)}
function onWriteInitFs(b){b.root.getFile("yttrack.txt",{create:!0},function(a){a.createWriter(function(a){a.onwriteend=function(a){console.log("Write completed.")};a.onerror=function(a){console.log("Write failed: "+a.toString())};var b=new Blob([""],{type:"text/plain"});a.write(b)},errorHandler)},errorHandler)}
function onAppendInitFs(b){b.root.getFile("yttrack.txt",{create:!1},function(a){a.createWriter(function(a){a.seek(a.length);var b=JSON.parse(localStorage.getItem("bst")),d="";for(i=0;i<b.length;i++)for(j=0;j<b[i].length;j++)d+=b[i][j][0]+": "+b[i][j][1]+"\n";initBst();initNum();b=new Blob([d],{type:"text/plain"});a.write(b)},errorHandler)},errorHandlerInit)}
function update(b,a){var c=JSON.parse(localStorage.getItem("bst")),g=parseInt(localStorage.getItem("num")),d=b.search("www.youtube.com/watch");if(0<=d){for(var d=b.substring(d+21),k=!1,e=parseInt(localStorage.getItem("dss")),e=(sha(d)%e+e)%e,f=c[e],h=1;h<f.length;h++)if(0===d.localeCompare(f[h][0])){k=!0;break}k||(0<=a.substring(a.length-10).search("YouTube")&&(a=a.substring(0,a.length-10)),f[f.length]=[d,a],c[e]=f,localStorage.setItem("bst",JSON.stringify(c)),c=JSON.parse(localStorage.getItem("queue")),
c.shift(),c.push(e+" "+f.length),localStorage.setItem("queue",JSON.stringify(c)),localStorage.setItem("num",g+1),c=localStorage.getItem("min"),g>c&&window.webkitRequestFileSystem(window.TEMPORARY,1048576,onAppendInitFs,errorHandler))}}
chrome.runtime.onMessage.addListener(function(b,a,c){if("updated"==b.msg)initSystem();else if("track"==b.msg)update(a.tab.url,a.tab.title);else if("generate"==b.msg)console.log("Generate called at "+b.url),chrome.tabs.create({active:!1,pinned:!0,url:"http://www.flv2mp3.com/"},function(a){setTimeout(function(){send(a.id,b.url)},3E3)});else if("getUrl"==b.msg){c=a.tab.url;var g=c.search("download/");url_n=c.substring(0,g+9)+"direct/"+c.substring(g+9);console.log("Creating "+url_n);chrome.tabs.create({active:!1,
pinned:!0,url:url_n},function(b){chrome.tabs.remove(a.tab.id)})}else console.log(b.msg)});function send(b,a){chrome.tabs.sendMessage(b,{url:a},function(a){console.log(chrome.runtime.lastError);console.log(a.farewell)})};
